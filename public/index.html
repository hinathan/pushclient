<link rel="stylesheet" href="/css/main.css" type="text/css" media="screen" title="no title" charset="utf-8">
<script src="/vendor/jquery.min.js" type="text/javascript" language="javascript" charset="utf-8"></script>
<script src="/vendor/pushstream.js" type="text/javascript" language="javascript" charset="utf-8"></script>
<script src="/vendor/jquery.dnd-file-upload.js" type="text/javascript" language="javascript" charset="utf-8"></script>
<script src="/vendor/jquery.client.js" type="text/javascript" language="javascript" charset="utf-8"></script>
<script src="/vendor/jquery.progressbar.js" type="text/javascript" language="javascript" charset="utf-8"></script>

<div id="log"></div>

<script type="text/javascript">

PushStream.LOG_LEVEL = 'error';
var pushstream = new PushStream({
	host: window.location.hostname,
	port: window.location.port,
	//	modes: "websockets|eventsource|stream",
	modes: "eventsource|longpolling",
});
pushstream.onrawmessage = function(event) {
	$('#log').append('<b>' + event.message + '</b> ' +  JSON.stringify(event) + '<br>')
	$("#log").prop('scrollTop',$("#log").prop("scrollHeight") + 100);
	
	
	if(event.message == 'output-delivered') {
		if(event.done_url.match(/pdf$/)) {
			var iframe = $('<iframe>').attr('src',event.done_url).css({width:'100%',height:'400px'})
			$('#results').append(iframe)
		} else if(event.done_url.match(/jpg$/)) {
			var img = $('<img>').attr('src',event.done_url)
			$('#results').append(img)
		}
	}
}
pushstream.onstatuschange = _statuschanged;
function _statuschanged(state) {
};

function _connect(channel) {
	pushstream.removeAllChannels();
	try {
		pushstream.addChannel(channel);
		pushstream.connect();
	} catch(e) {
		alert(e)
	};
}
</script>

<div id="drop-div" class="droppable">
	<span>Drop a PDF or Keynote file here! </span>
	<div id="document"></div>
	<div id="drop-info"></div>
</div>

<input type="button" name="newjob" value="newjob" id="newjob">

<script type="text/javascript">

function guidGenerator() {
	var S4 = function() {
		return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
	};
	return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
}

var ref = guidGenerator()

$(function() {
	var type = 'reverse';
	_connect(ref)
	$('#newjob').on('click',function() {
		$.ajax({
			url:'/ajaxnew.php',
			type:'POST',
			data:{ref:ref,type:type},
			success:function(data) { console.log('ajax-success');console.log(data); },
			error:function(data) { console.log('ajax-error');console.log(data); },
		})
	})
})
</script>


 <script>
$.fn.dropzone.uploadStarted = function(fileIndex, file) {
	// upload of file with given index has started
	$('#drop-div').removeClass('hovered')
	$('#drop-div').removeClass('droppable')
	$('#drop-info').html('uploading ' + escape(file.name) + '<div><div id="progressbar"></div></div>')
	$('#progressbar').reportprogress(0);
}
$.fn.dropzone.uploadFinished = function(fileIndex, file, time) {
    // upload of file with given index has finished; upload took *time* mili seconds
	$('#drop-div').addClass('droppable')
	$('#drop-info').html('uploaded ' + escape(file.name))
}
$.fn.dropzone.fileUploadProgressUpdated = function(fileIndex, file, newProgress) {
	// progress of given file has changed to *newProgress* percent
	$('#progressbar').reportprogress(newProgress);
}
$.fn.dropzone.uploadResponse = function(xhr) {
	var response = jQuery.parseJSON(xhr.response)
	
	var input_url = null
	var done_url = null
	var transform = null
	if(response.saved.match(/\.key$/)) {
		input_url = 'http://push.lensu.com/input/' + response.saved
		done_url = 'http://push.lensu.com/output/' +  response.saved + '.key.jpg'
		transform = 'keynotetojpg'
		do_transform(input_url,done_url,transform)
		input_url = 'http://push.lensu.com/input/' + response.saved
		done_url = 'http://push.lensu.com/output/' +  response.saved + '.key.pdf'
		transform = 'keynotetopdf'
		do_transform(input_url,done_url,transform)
	} else if(response.saved.match(/\.pdf$/)) {
			input_url = 'http://push.lensu.com/input/' + response.saved
			done_url = 'http://push.lensu.com/output/' +  response.saved + '.ocr.pdf'
			transform = 'pdftoocrpdf'
			do_transform(input_url,done_url,transform)
		}
	
}
function do_transform(input_url,done_url,transform) {
	$.ajax({
		url:'/ajaxnew.php',
		'type':'POST',
		data:{ref:ref,type:transform,input_url:input_url,done_url:done_url},
		success:function(data) { console.log("posted to ajaxnew"); console.log(data) },
		error:function(data) { console.log("error from ajaxnew "); console.log(data) },
	})
}

$(function(){
	$('#drop-div').on('dragenter',function() { $('#drop-div').addClass('hovered') })
	$('#drop-div').on('dragleave',function() { $('#drop-div').removeClass('hovered') })
	$("#drop-div").dropzone(
		{
			url : '/upload.php?ref=' + ref,
		}
	)
})
</script>

<div id="results"></div>
